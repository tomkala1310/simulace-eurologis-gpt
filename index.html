<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimalizace FVE</title>
    
    <!-- Tailwind CSS přes CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.min.js"></script>
    
    <!-- Styly -->
    <style>
        /* Případné dodatečné vlastní styly */
        .recharts-wrapper {
            margin: 0 auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root" class="p-4"></div>

    <!-- Přesunuto: logika a pomocné funkce -->
    <script>
    // Přesunuto z JSX do samostatného <script> v <head> pro oddělení logiky
    window.fveHelpers = {
        formatNumber: (num) => {
            return new Intl.NumberFormat('cs-CZ', {
                maximumFractionDigits: 0
            }).format(Math.round(num));
        },
        formatDecimal: (num, decimals = 2) => {
            return new Intl.NumberFormat('cs-CZ', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        },
        calculateResults: function ({
            miners, bess, additionalPower, bessAllocationForMiners, exportEnergyForBess, btcGrowthMultiplier,
            minerPrice, minerPower, bessBasePrice, bessDotace, bessCapacity, fvBasePrice, fvDotace, baseCapacity, maxAdditionalCapacity, baseEnergy
        }) {
            const fvPrice = fvBasePrice * (1 - fvDotace / 100);
            const bessPrice = bessBasePrice * (1 - bessDotace / 100);
            const totalCapacity = baseCapacity + additionalPower;
            const capacityRatio = totalCapacity / baseCapacity;
            const estimatedProduction = baseEnergy.totalProduction * capacityRatio;
            const extraProductionRatio = additionalPower / baseCapacity;
            const selfConsumptionGrowthFactor = extraProductionRatio > 0 ?
                Math.min(0.25, 0.40 * Math.exp(-extraProductionRatio / 2)) : 0;
            const newSelfConsumptionBase = baseEnergy.selfConsumption *
                (1 + (extraProductionRatio * selfConsumptionGrowthFactor));
            const newProduction = estimatedProduction;
            const newGridExportBase = newProduction - newSelfConsumptionBase;
            const potentialMinerHours = 365 * 24;
            const totalMinerPower = miners * minerPower;
            const potentialMinerEnergy = totalMinerPower * potentialMinerHours;
            const availableExportEnergy = newGridExportBase * 0.9;
            const bessCapacityTotal = bess * bessCapacity;
            const bessEfficiency = 0.95;
            const maxStorableEnergy = bess > 0 ? Math.min(
                bessCapacityTotal * 200,
                availableExportEnergy * (exportEnergyForBess / 100)
            ) * bessEfficiency : 0;
            const remainingExportAfterBess = availableExportEnergy - (maxStorableEnergy / bessEfficiency);
            const directEnergyForMiners = miners > 0 ? Math.min(
                totalMinerPower * (12 * 365),
                remainingExportAfterBess
            ) : 0;
            const bessEnergyForMiners = miners > 0 && bess > 0 ? Math.min(
                totalMinerPower * (6 * 365),
                maxStorableEnergy * (bessAllocationForMiners / 100)
            ) : 0;
            const bessEnergyForOther = maxStorableEnergy - bessEnergyForMiners;
            const totalMinerEnergy = directEnergyForMiners + bessEnergyForMiners;
            const minerOperationHours = totalMinerPower > 0 ? totalMinerEnergy / totalMinerPower : 0;
            const minerUtilization = (minerOperationHours / potentialMinerHours) * 100;
            const finalRemainingExport = availableExportEnergy - directEnergyForMiners - (maxStorableEnergy / bessEfficiency);
            const finalSelfConsumption = newSelfConsumptionBase + totalMinerEnergy + bessEnergyForOther;
            const finalSelfConsumptionRatio = (finalSelfConsumption / newProduction) * 100;
            const fveInvestment = additionalPower * fvPrice;
            const minerInvestment = miners * minerPrice;
            const bessInvestment = bess * bessPrice;
            const totalInvestment = fveInvestment + minerInvestment + bessInvestment;
            const priceDifference = 5.3;
            const energySavings = bessEnergyForOther * priceDifference;
            const exportRate = 1.5;
            const exportRevenue = finalRemainingExport * exportRate;
            const baseDailyProfitPerMiner = 274 / 30;
            const usdRate = 25;
            const adjustedDailyProfitPerMiner = baseDailyProfitPerMiner * (btcGrowthMultiplier / 100);
            const daysEquivalent = minerOperationHours / 24;
            const miningRevenue = miners * adjustedDailyProfitPerMiner * usdRate * daysEquivalent;
            const totalRevenue = miningRevenue + energySavings + exportRevenue;
            const paybackYears = totalRevenue > 0 ? totalInvestment / totalRevenue : Infinity;
            return {
                totalCapacity,
                additionalCapacity: additionalPower,
                totalProduction: newProduction,
                baselineProduction: baseEnergy.totalProduction,
                directEnergyForMiners,
                bessEnergyForMiners,
                bessEnergyForOther,
                totalMinerEnergy,
                finalRemainingExport,
                newSelfConsumptionBase,
                finalSelfConsumption,
                finalSelfConsumptionRatio,
                minerOperationHours,
                minerUtilization,
                bessUtilization: bessCapacityTotal > 0 ? (maxStorableEnergy / (bessCapacityTotal * 365)) * 100 : 0,
                fveInvestment,
                minerInvestment,
                bessInvestment,
                totalInvestment,
                miningRevenue,
                energySavings,
                exportRevenue,
                totalRevenue,
                paybackYears
            };
        }
    };
    </script>

    <script type="text/babel">
    // Destrukturování Recharts komponent
    const {
        ResponsiveContainer, PieChart, Pie, Cell,
        LineChart, Line, XAxis, YAxis, CartesianGrid,
        Tooltip, Legend
    } = Recharts;

    // Helper hooks pro tooltipy sliderů
    function useSliderTooltip(initialValue) {
        const [show, setShow] = React.useState(false);
        const [value, setValue] = React.useState(initialValue);
        const ref = React.useRef(null);
        return {
            ref,
            show,
            setShow,
            value,
            setValue,
            events: {
                onMouseDown: () => setShow(true),
                onMouseUp: () => setShow(false),
                onTouchStart: () => setShow(true),
                onTouchEnd: () => setShow(false),
            }
        };
    }

    // Dashboard strip component
    function DashboardStrip({ results, formatNumber, formatDecimal }) {
        return (
            <div className="flex flex-wrap gap-4 mb-4">
                <div className="flex-1 min-w-[160px] bg-green-100 rounded p-3 text-center">
                    <div className="text-xs text-gray-700">Roční výnos</div>
                    <div className="font-bold text-lg">{formatNumber(results.totalRevenue)} Kč</div>
                </div>
                <div className="flex-1 min-w-[160px] bg-yellow-100 rounded p-3 text-center">
                    <div className="text-xs text-gray-700">Návratnost investice</div>
                    <div className="font-bold text-lg">{!isFinite(results.paybackYears) ? "N/A" : formatDecimal(results.paybackYears, 1) + " let"}</div>
                </div>
                <div className="flex-1 min-w-[160px] bg-blue-100 rounded p-3 text-center">
                    <div className="text-xs text-gray-700">Pokrytí spotřeby (%)</div>
                    <div className="font-bold text-lg">{formatDecimal((results.finalSelfConsumption / 3138654) * 100, 1)}%</div>
                </div>
                <div className="flex-1 min-w-[160px] bg-orange-100 rounded p-3 text-center">
                    <div className="text-xs text-gray-700">Využití minerů (%)</div>
                    <div className="font-bold text-lg">{formatDecimal(results.minerUtilization, 1)}%</div>
                </div>
            </div>
        );
    }

    // AI Asistent komponenta
    function AIAsistent({ onSuggest }) {
        const [input, setInput] = React.useState('');
        const [suggestion, setSuggestion] = React.useState('');
        function handleSuggest() {
            // Simulovaný návrh - v praxi by byl výstup AI
            setSuggestion("Navrhuji 6 BESS, 80 minerů a 2200 kWp.");
            if (onSuggest) onSuggest({ bess: 6, miners: 80, additionalPower: 2200 });
        }
        return (
            <div className="bg-white rounded shadow p-4 mb-4">
                <h3 className="font-semibold mb-2">AI Asistent</h3>
                <div className="flex gap-2 mb-2">
                    <input
                        type="text"
                        className="flex-1 border border-gray-300 rounded px-2 py-1"
                        placeholder="Popište požadavek (např. maximalizuj výnos)..."
                        value={input}
                        onChange={e => setInput(e.target.value)}
                    />
                    <button
                        className="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
                        onClick={handleSuggest}
                    >Navrhni konfiguraci</button>
                </div>
                {suggestion && (
                    <div className="bg-blue-50 rounded p-2">{suggestion}</div>
                )}
            </div>
        );
    }

    // Porovnávací tabulka scénářů
    function ComparisonTable({ base, optimized, formatNumber, formatDecimal }) {
        return (
            <div className="overflow-x-auto mt-6">
                <table className="min-w-full border border-gray-200 text-sm">
                    <thead>
                        <tr className="bg-gray-100">
                            <th className="p-2 text-left">Parametr</th>
                            <th className="p-2 text-center">Výchozí stav</th>
                            <th className="p-2 text-center">Optimalizovaný scénář</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td className="p-2">Výkon FVE [kWp]</td>
                            <td className="p-2 text-center">{formatDecimal(1496.32, 2)}</td>
                            <td className="p-2 text-center">{formatDecimal(optimized.totalCapacity, 2)}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Roční výroba [kWh]</td>
                            <td className="p-2 text-center">{formatNumber(base.totalProduction)}</td>
                            <td className="p-2 text-center">{formatNumber(optimized.totalProduction)}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Vlastní spotřeba [kWh]</td>
                            <td className="p-2 text-center">{formatNumber(base.selfConsumption)}</td>
                            <td className="p-2 text-center">{formatNumber(optimized.finalSelfConsumption)}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Podíl vlastní spotřeby [%]</td>
                            <td className="p-2 text-center">{formatDecimal(base.selfConsumptionRatio, 1)}</td>
                            <td className="p-2 text-center">{formatDecimal(optimized.finalSelfConsumptionRatio, 1)}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Počet minerů</td>
                            <td className="p-2 text-center">0</td>
                            <td className="p-2 text-center">{optimized.totalMinerEnergy > 0 ? Math.round(optimized.totalMinerEnergy / (5.428 * 8760)) : 0}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Počet BESS</td>
                            <td className="p-2 text-center">0</td>
                            <td className="p-2 text-center">{optimized.bessEnergyForOther + optimized.bessEnergyForMiners > 0 ? Math.round((optimized.bessEnergyForOther + optimized.bessEnergyForMiners) / (260 * 200)) : 0}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Roční výnos [Kč]</td>
                            <td className="p-2 text-center">0</td>
                            <td className="p-2 text-center">{formatNumber(optimized.totalRevenue)}</td>
                        </tr>
                        <tr>
                            <td className="p-2">Návratnost investice [let]</td>
                            <td className="p-2 text-center">-</td>
                            <td className="p-2 text-center">{!isFinite(optimized.paybackYears) ? "N/A" : formatDecimal(optimized.paybackYears, 1)}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        );
    }

    // Hlavní komponenta aplikace
    const FVEOptimalizace = () => {
        // Konfigurace a stavy
        const [miners, setMiners] = React.useState(4);
        const [bess, setBess] = React.useState(1);
        const [additionalPower, setAdditionalPower] = React.useState(0);
        const [bessAllocationForMiners, setBessAllocationForMiners] = React.useState(70);
        const [exportEnergyForBess, setExportEnergyForBess] = React.useState(50);
        const [btcGrowthMultiplier, setBtcGrowthMultiplier] = React.useState(100);
        const [bessBasePrice, setBessBasePrice] = React.useState(1625000);
        const [bessDotace, setBessDotace] = React.useState(0);
        const [fvBasePrice, setFvBasePrice] = React.useState(18000);
        const [fvDotace, setFvDotace] = React.useState(0);
        const [activeTab, setActiveTab] = React.useState('summary');

        // Slider tooltip hooks
        const minersTooltip = useSliderTooltip(miners);
        const bessTooltip = useSliderTooltip(bess);
        const additionalPowerTooltip = useSliderTooltip(additionalPower);
        const bessAllocationTooltip = useSliderTooltip(bessAllocationForMiners);
        const exportEnergyTooltip = useSliderTooltip(exportEnergyForBess);
        const btcGrowthTooltip = useSliderTooltip(btcGrowthMultiplier);
        const bessBasePriceTooltip = useSliderTooltip(bessBasePrice);
        const bessDotaceTooltip = useSliderTooltip(bessDotace);
        const fvBasePriceTooltip = useSliderTooltip(fvBasePrice);
        const fvDotaceTooltip = useSliderTooltip(fvDotace);

        // Parametry
        const minerPrice = 42990;
        const minerPower = 5.428;
        const bessCapacity = 260;
        const baseCapacity = 1496.32;
        const maxAdditionalCapacity = 3500;
        const baseEnergy = {
            totalProduction: 1447078,
            selfConsumption: 1213180,
            gridExport: 233898,
            nightExport: 21079,
            selfConsumptionRatio: 83.84,
            totalConsumption: 3138654
        };

        // Formátovací funkce a výpočty z helperu
        const { formatNumber, formatDecimal, calculateResults } = window.fveHelpers;
        const results = calculateResults({
            miners, bess, additionalPower, bessAllocationForMiners, exportEnergyForBess, btcGrowthMultiplier,
            minerPrice, minerPower, bessBasePrice, bessDotace, bessCapacity, fvBasePrice, fvDotace, baseCapacity, maxAdditionalCapacity, baseEnergy
        });

        // Data pro grafy
        const optimizedMixData = [
            { name: 'Vlastní spotřeba', value: results.newSelfConsumptionBase, color: '#4CAF50' },
            { name: 'Těžba (přímá)', value: results.directEnergyForMiners, color: '#FF9800' },
            { name: 'Těžba (z BESS)', value: results.bessEnergyForMiners, color: '#FF5722' },
            { name: 'BESS (jiné využití)', value: results.bessEnergyForOther, color: '#9C27B0' },
            { name: 'Zbývající přetoky', value: results.finalRemainingExport, color: '#2196F3' }
        ];
        // PieChart pod ekonomikou
        const economicsPieData = [
            { name: 'Výnos z těžby', value: results.miningRevenue, color: '#FF9800' },
            { name: 'Úspora z BESS', value: results.energySavings, color: '#9C27B0' },
            { name: 'Prodej přetoků', value: results.exportRevenue, color: '#2196F3' }
        ];
        // Měsíční data pro graf
        const monthlyData = [
            { name: 'Led', original: 95.5, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(98.5, 95.5 + (miners * 0.4) + (bess * 0.6)) : 95.5 },
            { name: 'Úno', original: 90.7, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(97.8, 90.7 + (miners * 0.5) + (bess * 0.7)) : 90.7 },
            { name: 'Bře', original: 80.0, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(96.5, 80.0 + (miners * 0.8) + (bess * 1.0)) : 80.0 },
            { name: 'Dub', original: 82.5, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(97.0, 82.5 + (miners * 0.7) + (bess * 0.9)) : 82.5 },
            { name: 'Kvě', original: 80.8, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(96.8, 80.8 + (miners * 0.8) + (bess * 1.0)) : 80.8 },
            { name: 'Čvn', original: 81.7, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(96.5, 81.7 + (miners * 0.7) + (bess * 0.9)) : 81.7 },
            { name: 'Čvc', original: 84.3, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(97.2, 84.3 + (miners * 0.7) + (bess * 0.8)) : 84.3 },
            { name: 'Srp', original: 83.7, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(97.0, 83.7 + (miners * 0.7) + (bess * 0.9)) : 83.7 },
            { name: 'Zář', original: 84.2, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(96.8, 84.2 + (miners * 0.6) + (bess * 0.8)) : 84.2 },
            { name: 'Říj', original: 93.2, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(98.3, 93.2 + (miners * 0.3) + (bess * 0.5)) : 93.2 },
            { name: 'Lis', original: 93.0, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(98.2, 93.0 + (miners * 0.3) + (bess * 0.5)) : 93.0 },
            { name: 'Pro', original: 97.6, optimized: results.finalSelfConsumptionRatio > 0 ? Math.min(99.0, 97.6 + (miners * 0.1) + (bess * 0.3)) : 97.6 }
        ];
        // Pro graf návratnosti v čase
        const years = Array.from({ length: 21 }, (_, i) => i);
        const cumulativeRevenues = years.map(year => ({
            year,
            cumulative: results.totalRevenue * year,
            investment: results.totalInvestment
        }));

        // Taby
        const tabs = [
            { key: 'summary', label: 'Souhrn' },
            { key: 'energy', label: 'Energetická bilance' },
            { key: 'economics', label: 'Ekonomická analýza' },
            { key: 'charts', label: 'Grafy' }
        ];

        // Pro tooltipy sliderů
        function renderSliderTooltip(show, value, ref) {
            return show ? (
                <div
                    className="absolute z-10 bg-gray-800 text-white text-xs px-2 py-1 rounded -top-8 left-1/2 -translate-x-1/2"
                    style={{ pointerEvents: 'none' }}
                >
                    {value}
                </div>
            ) : null;
        }

        // JSX
        return (
            <div className="p-4 max-w-6xl mx-auto">
                <h1 className="text-2xl font-bold mb-4">Optimalizace FVE pomocí rozšířeného výkonu, minerů a bateriového systému</h1>

                {/* Tabs navigation */}
                <ul className="flex border-b mb-6">
                    {tabs.map(tab => (
                        <li key={tab.key} className={`mr-2`}>
                            <button
                                className={`px-4 py-2 rounded-t ${activeTab === tab.key ? 'bg-white border-t border-l border-r border-b-0 font-semibold' : 'bg-gray-200 text-gray-600'}`}
                                onClick={() => setActiveTab(tab.key)}
                            >
                                {tab.label}
                            </button>
                        </li>
                    ))}
                </ul>

                {/* Dashboard strip */}
                <DashboardStrip results={results} formatNumber={formatNumber} formatDecimal={formatDecimal} />

                {/* Taby obsah */}
                {activeTab === 'summary' && (
                <>
                    <AIAsistent />
                    {/* Konfigurace */}
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Konfigurace systému</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {/* Rozšíření výkonu FVE */}
                            <div className="relative">
                                <div className="flex justify-between mb-1">
                                    <label className="font-medium">Rozšíření výkonu FVE</label>
                                    <span className="font-bold">{formatNumber(additionalPower)} kWp</span>
                                </div>
                                <div className="relative">
                                    <input
                                        ref={additionalPowerTooltip.ref}
                                        type="range"
                                        min="0"
                                        max={maxAdditionalCapacity}
                                        step="100"
                                        value={additionalPower}
                                        onChange={e => { setAdditionalPower(parseInt(e.target.value)); additionalPowerTooltip.setValue(e.target.value); }}
                                        className="w-full mb-2"
                                        onMouseDown={additionalPowerTooltip.events.onMouseDown}
                                        onMouseUp={additionalPowerTooltip.events.onMouseUp}
                                        onTouchStart={additionalPowerTooltip.events.onTouchStart}
                                        onTouchEnd={additionalPowerTooltip.events.onTouchEnd}
                                    />
                                    {renderSliderTooltip(additionalPowerTooltip.show, additionalPower, additionalPowerTooltip.ref)}
                                </div>
                                <div className="text-sm bg-green-50 p-2 rounded">
                                    <p>Stávající výkon: {formatDecimal(baseCapacity, 2)} kWp</p>
                                    <p>Nový celkový výkon: {formatDecimal(baseCapacity + additionalPower, 2)} kWp</p>
                                    <p>Investice do rozšíření: {formatNumber(additionalPower * (fvBasePrice * (1 - fvDotace / 100)))} Kč</p>
                                </div>
                            </div>
                            {/* Minery */}
                            <div className="relative">
                                <div className="flex justify-between mb-1">
                                    <label className="font-medium">Počet těžebních stanic Antminer S19 Pro Hydro</label>
                                    <span className="font-bold">{miners} ks</span>
                                </div>
                                <div className="relative">
                                    <input
                                        ref={minersTooltip.ref}
                                        type="range"
                                        min="0"
                                        max="300"
                                        step="5"
                                        value={miners}
                                        onChange={e => { setMiners(parseInt(e.target.value)); minersTooltip.setValue(e.target.value); }}
                                        className="w-full mb-2"
                                        onMouseDown={minersTooltip.events.onMouseDown}
                                        onMouseUp={minersTooltip.events.onMouseUp}
                                        onTouchStart={minersTooltip.events.onTouchStart}
                                        onTouchEnd={minersTooltip.events.onTouchEnd}
                                    />
                                    {renderSliderTooltip(minersTooltip.show, miners, minersTooltip.ref)}
                                </div>
                                <div className="text-sm bg-orange-50 p-2 rounded">
                                    <p>Výkon: {minerPower} kW/ks</p>
                                    <p>Celkový výkon: {formatDecimal(miners * minerPower, 2)} kW</p>
                                    <p>Cena za kus: {formatNumber(minerPrice)} Kč</p>
                                    <p>Celkem: {formatNumber(miners * minerPrice)} Kč</p>
                                </div>
                            </div>
                            {/* BESS */}
                            <div className="relative">
                                <div className="flex justify-between mb-1">
                                    <label className="font-medium">Počet bateriových systémů OPTIM US L260-OMNI</label>
                                    <span className="font-bold">{bess} ks</span>
                                </div>
                                <div className="relative">
                                    <input
                                        ref={bessTooltip.ref}
                                        type="range"
                                        min="0"
                                        max="40"
                                        step="1"
                                        value={bess}
                                        onChange={e => { setBess(parseInt(e.target.value)); bessTooltip.setValue(e.target.value); }}
                                        className="w-full mb-2"
                                        onMouseDown={bessTooltip.events.onMouseDown}
                                        onMouseUp={bessTooltip.events.onMouseUp}
                                        onTouchStart={bessTooltip.events.onTouchStart}
                                        onTouchEnd={bessTooltip.events.onTouchEnd}
                                    />
                                    {renderSliderTooltip(bessTooltip.show, bess, bessTooltip.ref)}
                                </div>
                                <div className="text-sm bg-purple-50 p-2 rounded">
                                    <p>Kapacita: {bessCapacity} kWh/ks</p>
                                    <p>Celková kapacita: {bess * bessCapacity} kWh</p>
                                    <p>Cena s instalací: {formatNumber(bessBasePrice * (1 - bessDotace / 100))} Kč/ks</p>
                                    <p>Celkem: {formatNumber(bess * (bessBasePrice * (1 - bessDotace / 100)))} Kč</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Cenová nastavení a dotace */}
                        <div className="mt-6">
                          <h3 className="text-md font-semibold mb-3">Cenová nastavení a dotace</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-green-50 p-3 rounded">
                              <h4 className="font-medium">Fotovoltaický systém</h4>
                              <div className="mt-2">
                                <div className="flex justify-between mb-1">
                                  <label className="text-sm">Základní cena FVE</label>
                                  <span className="font-bold">{formatNumber(fvBasePrice)} Kč/kWp</span>
                                </div>
                                <div className="relative">
                                  <input
                                    ref={fvBasePriceTooltip.ref}
                                    type="range"
                                    min="10000"
                                    max="30000"
                                    step="1000"
                                    value={fvBasePrice}
                                    onChange={e => { setFvBasePrice(parseInt(e.target.value)); fvBasePriceTooltip.setValue(e.target.value); }}
                                    className="w-full mb-2"
                                    onMouseDown={fvBasePriceTooltip.events.onMouseDown}
                                    onMouseUp={fvBasePriceTooltip.events.onMouseUp}
                                    onTouchStart={fvBasePriceTooltip.events.onTouchStart}
                                    onTouchEnd={fvBasePriceTooltip.events.onTouchEnd}
                                  />
                                  {renderSliderTooltip(fvBasePriceTooltip.show, fvBasePrice, fvBasePriceTooltip.ref)}
                                </div>
                                <div className="flex justify-between mb-1">
                                  <label className="text-sm">Dotace na FVE</label>
                                  <span className="font-bold">{fvDotace}%</span>
                                </div>
                                <div className="relative">
                                  <input
                                    ref={fvDotaceTooltip.ref}
                                    type="range"
                                    min="0"
                                    max="50"
                                    step="5"
                                    value={fvDotace}
                                    onChange={e => { setFvDotace(parseInt(e.target.value)); fvDotaceTooltip.setValue(e.target.value); }}
                                    className="w-full mb-2"
                                    onMouseDown={fvDotaceTooltip.events.onMouseDown}
                                    onMouseUp={fvDotaceTooltip.events.onMouseUp}
                                    onTouchStart={fvDotaceTooltip.events.onTouchStart}
                                    onTouchEnd={fvDotaceTooltip.events.onTouchEnd}
                                  />
                                  {renderSliderTooltip(fvDotaceTooltip.show, fvDotace + " %", fvDotaceTooltip.ref)}
                                </div>
                                <div className="text-sm mt-2">
                                  <p>Výsledná cena po dotaci: <strong>{formatNumber(fvPrice)} Kč/kWp</strong></p>
                                  <p>Úspora díky dotaci: <strong>{formatNumber(fvBasePrice - fvPrice)} Kč/kWp</strong></p>
                                </div>
                              </div>
                            </div>
                            
                            <div className="bg-purple-50 p-3 rounded">
                              <h4 className="font-medium">Bateriový systém</h4>
                              <div className="mt-2">
                                <div className="flex justify-between mb-1">
                                  <label className="text-sm">Základní cena BESS</label>
                                  <span className="font-bold">{formatNumber(bessBasePrice)} Kč/ks</span>
                                </div>
                                <div className="relative">
                                  <input
                                    ref={bessBasePriceTooltip.ref}
                                    type="range"
                                    min="1000000"
                                    max="2500000"
                                    step="50000"
                                    value={bessBasePrice}
                                    onChange={e => { setBessBasePrice(parseInt(e.target.value)); bessBasePriceTooltip.setValue(e.target.value); }}
                                    className="w-full mb-2"
                                    onMouseDown={bessBasePriceTooltip.events.onMouseDown}
                                    onMouseUp={bessBasePriceTooltip.events.onMouseUp}
                                    onTouchStart={bessBasePriceTooltip.events.onTouchStart}
                                    onTouchEnd={bessBasePriceTooltip.events.onTouchEnd}
                                  />
                                  {renderSliderTooltip(bessBasePriceTooltip.show, bessBasePrice, bessBasePriceTooltip.ref)}
                                </div>
                                <div className="flex justify-between mb-1">
                                  <label className="text-sm">Dotace na BESS</label>
                                  <span className="font-bold">{bessDotace}%</span>
                                </div>
                                <div className="relative">
                                  <input
                                    ref={bessDotaceTooltip.ref}
                                    type="range"
                                    min="0"
                                    max="50"
                                    step="5"
                                    value={bessDotace}
                                    onChange={e => { setBessDotace(parseInt(e.target.value)); bessDotaceTooltip.setValue(e.target.value); }}
                                    className="w-full mb-2"
                                    onMouseDown={bessDotaceTooltip.events.onMouseDown}
                                    onMouseUp={bessDotaceTooltip.events.onMouseUp}
                                    onTouchStart={bessDotaceTooltip.events.onTouchStart}
                                    onTouchEnd={bessDotaceTooltip.events.onTouchEnd}
                                  />
                                  {renderSliderTooltip(bessDotaceTooltip.show, bessDotace + " %", bessDotaceTooltip.ref)}
                                </div>
                                <div className="text-sm mt-2">
                                  <p>Výsledná cena po dotaci: <strong>{formatNumber(bessPrice)} Kč/ks</strong></p>
                                  <p>Úspora díky dotaci: <strong>{formatNumber(bessBasePrice - bessPrice)} Kč/ks</strong></p>
                                  <p>Cena za kWh: <strong>{formatNumber(bessPrice / bessCapacity)} Kč/kWh</strong></p>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        
                        {/* Rozšířené nastavení alokace energie */}
                        <div className="mt-4">
                            <h3 className="text-md font-semibold mb-3">Rozšířené nastavení alokace energie</h3>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="font-medium">Podíl energie z BESS pro minery</label>
                                        <span className="font-bold">{bessAllocationForMiners}%</span>
                                    </div>
                                    <div className="relative">
                                        <input
                                            ref={bessAllocationTooltip.ref}
                                            type="range"
                                            min="0"
                                            max="100"
                                            step="5"
                                            value={bessAllocationForMiners}
                                            onChange={e => { setBessAllocationForMiners(parseInt(e.target.value)); bessAllocationTooltip.setValue(e.target.value); }}
                                            className="w-full mb-2"
                                            onMouseDown={bessAllocationTooltip.events.onMouseDown}
                                            onMouseUp={bessAllocationTooltip.events.onMouseUp}
                                            onTouchStart={bessAllocationTooltip.events.onTouchStart}
                                            onTouchEnd={bessAllocationTooltip.events.onTouchEnd}
                                        />
                                        {renderSliderTooltip(bessAllocationTooltip.show, bessAllocationForMiners + " %", bessAllocationTooltip.ref)}
                                    </div>
                                    <div className="text-sm bg-blue-50 p-2 rounded">
                                        <p>Pro minery: {bessAllocationForMiners}%</p>
                                        <p>Pro jiné využití: {100 - bessAllocationForMiners}%</p>
                                        <p className="text-xs text-gray-600 mt-1">Nastavení určuje, jaký podíl energie z baterií bude využit pro provoz těžebních stanic a jaký pro jiné účely.</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="font-medium">Podíl přetoků pro BESS</label>
                                        <span className="font-bold">{exportEnergyForBess}%</span>
                                    </div>
                                    <div className="relative">
                                        <input
                                            ref={exportEnergyTooltip.ref}
                                            type="range"
                                            min="0"
                                            max="100"
                                            step="5"
                                            value={exportEnergyForBess}
                                            onChange={e => { setExportEnergyForBess(parseInt(e.target.value)); exportEnergyTooltip.setValue(e.target.value); }}
                                            className="w-full mb-2"
                                            onMouseDown={exportEnergyTooltip.events.onMouseDown}
                                            onMouseUp={exportEnergyTooltip.events.onMouseUp}
                                            onTouchStart={exportEnergyTooltip.events.onTouchStart}
                                            onTouchEnd={exportEnergyTooltip.events.onTouchEnd}
                                        />
                                        {renderSliderTooltip(exportEnergyTooltip.show, exportEnergyForBess + " %", exportEnergyTooltip.ref)}
                                    </div>
                                    <div className="text-sm bg-yellow-50 p-2 rounded">
                                        <p>Pro baterie: {exportEnergyForBess}%</p>
                                        <p>Přímo pro minery: {100 - exportEnergyForBess}%</p>
                                        <p className="text-xs text-gray-600 mt-1">Nastavení určuje, jaký podíl přebytků z FVE bude primárně směrován do bateriového systému a jaký bude dostupný pro přímé využití u minerů.</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <div className="flex justify-between mb-1">
                                        <label className="font-medium">Predikce vývoje BTC</label>
                                        <span className="font-bold">{btcGrowthMultiplier}%</span>
                                    </div>
                                    <div className="relative">
                                        <input
                                            ref={btcGrowthTooltip.ref}
                                            type="range"
                                            min="10"
                                            max="500"
                                            step="10"
                                            value={btcGrowthMultiplier}
                                            onChange={e => { setBtcGrowthMultiplier(parseInt(e.target.value)); btcGrowthTooltip.setValue(e.target.value); }}
                                            className="w-full mb-2"
                                            onMouseDown={btcGrowthTooltip.events.onMouseDown}
                                            onMouseUp={btcGrowthTooltip.events.onMouseUp}
                                            onTouchStart={btcGrowthTooltip.events.onTouchStart}
                                            onTouchEnd={btcGrowthTooltip.events.onTouchEnd}
                                        />
                                        {renderSliderTooltip(btcGrowthTooltip.show, btcGrowthMultiplier + " %", btcGrowthTooltip.ref)}
                                    </div>
                                    <div className="text-sm bg-red-50 p-2 rounded">
                                        <p>Výchozí výnosnost (100%): {formatNumber(274 * 12 * 25 / 30)} Kč/rok/miner</p>
                                        <p>Upravená výnosnost ({btcGrowthMultiplier}%): {formatNumber(274 * 12 * 25 / 30 * btcGrowthMultiplier / 100)} Kč/rok/miner</p>
                                        <p className="text-xs text-gray-600 mt-1">Simuluje změnu výnosnosti těžby v důsledku změny ceny BTC, složitosti těžby a nákladů na provoz.</p>
                                        <p className="text-xs text-blue-700 mt-1">Bod zlomu: BTC musí dosáhnout přibližně 303% aktuální hodnoty, aby minery byly výnosnější než BESS.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Hlavní výsledky */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div className="bg-white p-4 rounded shadow">
                            <h2 className="text-lg font-semibold mb-3">Energetická bilance</h2>
                            <div className="h-60">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie
                                            data={optimizedMixData}
                                            cx="50%"
                                            cy="50%"
                                            labelLine={false}
                                            outerRadius={80}
                                            dataKey="value"
                                        >
                                            {optimizedMixData.map((entry, index) => (
                                                <Cell key={`cell-${index}`} fill={entry.color} />
                                            ))}
                                        </Pie>
                                        <Legend />
                                        <Tooltip formatter={(value) => formatNumber(value) + " kWh"} />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                            <div className="mt-3 grid grid-cols-2 gap-2">
                                <div className="bg-blue-50 p-2 rounded">
                                    <p className="text-sm font-semibold">Původní vlastní spotřeba</p>
                                    <p>{formatDecimal(baseEnergy.selfConsumptionRatio, 1)}%</p>
                                </div>
                                <div className="bg-green-50 p-2 rounded">
                                    <p className="text-sm font-semibold">Nová vlastní spotřeba</p>
                                    <p>{formatDecimal(results.finalSelfConsumptionRatio, 1)}%</p>
                                </div>
                            </div>
                            <div className="mt-2 p-2 rounded bg-gray-50">
                                <p className="text-xs text-gray-600">Alokace energie z BESS: {bessAllocationForMiners}% pro minery, {100-bessAllocationForMiners}% pro jiné využití</p>
                                <p className="text-xs text-gray-600">Využití přetoků: {exportEnergyForBess}% pro BESS, {100-exportEnergyForBess}% přímo pro minery</p>
                                <p className="text-xs text-gray-600">Predikce BTC: {btcGrowthMultiplier}% výchozí hodnoty</p>
                            </div>
                        </div>
                        
                        <div className="bg-white p-4 rounded shadow">
                            <h2 className="text-lg font-semibold mb-3">Ekonomická analýza</h2>
                            <div className="grid grid-cols-2 gap-3 mb-3">
                                <div className="bg-red-50 p-2 rounded">
                                    <p className="text-sm font-semibold">Celková investice</p>
                                    <p className="text-xl font-bold">{formatNumber(results.totalInvestment)} Kč</p>
                                </div>
                                <div className="bg-green-50 p-2 rounded">
                                    <p className="text-sm font-semibold">Roční výnos</p>
                                    <p className="text-xl font-bold">{formatNumber(results.totalRevenue)} Kč</p>
                                </div>
                            </div>
                            <div className="bg-yellow-50 p-3 rounded mb-3">
                                <p className="text-sm font-semibold">Návratnost investice</p>
                                <p className="text-xl font-bold">{!isFinite(results.paybackYears) ? "N/A" : formatDecimal(results.paybackYears, 1) + " let"}</p>
                            </div>
                            <div className="text-sm">
                                <p><strong>Příjem z těžby:</strong> {formatNumber(results.miningRevenue)} Kč/rok</p>
                                <p><strong>Úspora z BESS:</strong> {formatNumber(results.energySavings)} Kč/rok</p>
                                <p><strong>Prodej přetoků:</strong> {formatNumber(results.exportRevenue)} Kč/rok</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Detailní analýza alokace energie */}
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Detailní analýza alokace energie</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="p-3 rounded bg-orange-50">
                                <h3 className="font-medium">Analýza přetoků a akumulace</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Dostupné přetoky: {formatNumber(results.totalProduction - results.newSelfConsumptionBase)} kWh</li>
                                    <li>Energie pro BESS: {formatNumber((results.bessEnergyForMiners + results.bessEnergyForOther) / 0.95)} kWh</li>
                                    <li>Energie pro přímé využití minery: {formatNumber(results.directEnergyForMiners)} kWh</li>
                                    <li>Nevyužité přetoky: {formatNumber(results.finalRemainingExport)} kWh</li>
                                </ul>
                            </div>
                            
                            <div className="p-3 rounded bg-blue-50">
                                <h3 className="font-medium">Analýza provozu minerů</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Maximální potřeba: {formatNumber(miners * minerPower * 8760)} kWh/rok</li>
                                    <li>Dostupná energie z přetoků: {formatNumber(results.directEnergyForMiners)} kWh</li>
                                    <li>Dostupná energie z BESS: {formatNumber(results.bessEnergyForMiners)} kWh</li>
                                    <li>Celková dostupná energie: {formatNumber(results.totalMinerEnergy)} kWh</li>
                                    <li>Provozní hodiny: {formatDecimal(results.minerOperationHours, 0)} h/rok</li>
                                    <li>Využití kapacity: {formatDecimal(results.minerUtilization, 1)}%</li>
                                    <li>Aktuální výnos z 1 kWh: {formatDecimal(274 * 12 * 25 / 30 / (minerPower * 24) * btcGrowthMultiplier / 100, 2)} Kč/kWh</li>
                                    <li>Výnos BESS z 1 kWh: 5,30 Kč/kWh</li>
                                </ul>
                            </div>
                            
                            <div className="p-3 rounded bg-purple-50">
                                <h3 className="font-medium">Analýza BESS</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Celková kapacita: {formatNumber(bess * bessCapacity)} kWh</li>
                                    <li>Maximální roční průtok: {formatNumber(bess * bessCapacity * 200)} kWh</li>
                                    <li>Skutečný roční průtok: {formatNumber(results.bessEnergyForMiners + results.bessEnergyForOther)} kWh</li>
                                    <li>Pro minery: {formatNumber(results.bessEnergyForMiners)} kWh ({formatDecimal((results.bessEnergyForMiners / (results.bessEnergyForMiners + results.bessEnergyForOther || 1)) * 100, 1)}%)</li>
                                    <li>Pro jiné využití: {formatNumber(results.bessEnergyForOther)} kWh ({formatDecimal((results.bessEnergyForOther / (results.bessEnergyForMiners + results.bessEnergyForOther || 1)) * 100, 1)}%)</li>
                                    <li>Využití kapacity: {formatDecimal(results.bessUtilization, 1)}%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    {/* Měsíční analýza */}
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Měsíční vlastní spotřeba</h2>
                        <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart
                                    data={monthlyData}
                                    margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                >
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="name" />
                                    <YAxis domain={[75, 100]} />
                                    <Tooltip />
                                    <Legend />
                                    <Line type="monotone" dataKey="original" name="Původní" stroke="#8884d8" />
                                    <Line type="monotone" dataKey="optimized" name="Optimalizovaná" stroke="#82ca9d" />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    
                    {/* Porovnání výroby */}
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Porovnání výroby a spotřeby</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="p-3 rounded bg-green-50">
                                <h3 className="font-medium">Původní FVE</h3>
                                <p><strong>Výkon:</strong> {formatDecimal(baseCapacity, 2)} kWp</p>
                                <p><strong>Roční výroba:</strong> {formatNumber(baseEnergy.totalProduction)} kWh</p>
                                <p><strong>Vlastní spotřeba:</strong> {formatNumber(baseEnergy.selfConsumption)} kWh</p>
                                <p><strong>Přetoky do sítě:</strong> {formatNumber(baseEnergy.gridExport)} kWh</p>
                                <p><strong>Podíl vlastní spotřeby:</strong> {formatDecimal(baseEnergy.selfConsumptionRatio, 2)}%</p>
                                <p className="mt-2 font-medium">Celková spotřeba areálu: {formatNumber(baseEnergy.totalConsumption)} kWh/rok</p>
                            </div>
                            
                            <div className="p-3 rounded bg-blue-50">
                                <h3 className="font-medium">Rozšířená FVE</h3>
                                <p><strong>Výkon:</strong> {formatDecimal(results.totalCapacity, 2)} kWp</p>
                                <p><strong>Roční výroba:</strong> {formatNumber(results.totalProduction)} kWh</p>
                                <p><strong>Vlastní spotřeba:</strong> {formatNumber(results.newSelfConsumptionBase)} kWh</p>
                                <p><strong>Dostupné přetoky:</strong> {formatNumber(results.totalProduction - results.newSelfConsumptionBase)} kWh</p>
                                <p><strong>Nárůst výroby:</strong> {formatDecimal(((results.totalProduction / baseEnergy.totalProduction) - 1) * 100, 1)}%</p>
                                <p className="mt-2"><strong>Pokrytí celkové spotřeby:</strong> {formatDecimal((results.totalProduction / baseEnergy.totalConsumption) * 100, 1)}%</p>
                            </div>
                            
                            <div className="p-3 rounded bg-yellow-50">
                                <h3 className="font-medium">Optimalizovaná FVE</h3>
                                <p><strong>Výkon:</strong> {formatDecimal(results.totalCapacity, 2)} kWp</p>
                                <p><strong>Roční výroba:</strong> {formatNumber(results.totalProduction)} kWh</p>
                                <p><strong>Celková vlastní spotřeba:</strong> {formatNumber(results.finalSelfConsumption)} kWh</p>
                                <p><strong>Zbytkové přetoky:</strong> {formatNumber(results.finalRemainingExport)} kWh</p>
                                <p><strong>Podíl vlastní spotřeby:</strong> {formatDecimal(results.finalSelfConsumptionRatio, 2)}%</p>
                                <p className="mt-2"><strong>Poměr k roční spotřebě:</strong> {formatDecimal((results.finalSelfConsumption / baseEnergy.totalConsumption) * 100, 1)}%</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Shrnutí */}
                    <div className="bg-white p-4 rounded shadow">
                        <h2 className="text-lg font-semibold mb-3">Výsledek optimalizace</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-green-50 p-3 rounded">
                                <h3 className="font-medium">Fotovoltaický systém</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Stávající výkon: {formatDecimal(baseCapacity, 2)} kWp</li>
                                    <li>Rozšíření o: {formatNumber(results.additionalCapacity)} kWp</li>
                                    <li>Nový celkový výkon: {formatDecimal(results.totalCapacity, 2)} kWp</li>
                                    <li>Nárůst výroby: {formatNumber(results.totalProduction - baseEnergy.totalProduction)} kWh/rok</li>
                                    <li>Investice do rozšíření: {formatNumber(results.fveInvestment)} Kč</li>
                                </ul>
                            </div>
                            
                            <div className="bg-orange-50 p-3 rounded">
                                <h3 className="font-medium">Těžební stanice</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Počet minerů: {miners} ks</li>
                                    <li>Celkový výkon: {formatDecimal(miners * minerPower, 2)} kW</li>
                                    <li>Hodiny provozu: {formatNumber(results.minerOperationHours)} h/rok</li>
                                    <li>Využití kapacity: {formatDecimal(results.minerUtilization, 1)}%</li>
                                    <li>Výnosnost na miner: {formatNumber(274 * 12 * 25 / 30 * btcGrowthMultiplier / 100)} Kč/rok</li>
                                    <li>Investice: {formatNumber(results.minerInvestment)} Kč</li>
                                    <li>Roční výnos: {formatNumber(results.miningRevenue)} Kč</li>
                                </ul>
                            </div>
                            
                            <div className="bg-purple-50 p-3 rounded">
                                <h3 className="font-medium">Bateriový systém</h3>
                                <ul className="mt-2 list-disc pl-5 space-y-1">
                                    <li>Počet BESS: {bess} ks</li>
                                    <li>Celková kapacita: {formatNumber(bess * bessCapacity)} kWh</li>
                                    <li>Využití pro těžbu: {formatNumber(results.bessEnergyForMiners)} kWh</li>
                                    <li>Využití pro úsporu: {formatNumber(results.bessEnergyForOther)} kWh</li>
                                    <li>Využití kapacity: {formatDecimal(results.bessUtilization, 1)}%</li>
                                    <li>Investice: {formatNumber(results.bessInvestment)} Kč</li>
                                    <li>Roční úspora: {formatNumber(results.energySavings)} Kč</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div className="mt-4 bg-green-50 p-3 rounded">
                            <h3 className="font-medium text-center">Zhodnocení optimalizace</h3>
                            <p className="mt-2 text-center">
                                Při aktuální konfiguraci s rozšířením o {formatNumber(results.additionalCapacity)} kWp, {miners} minery a {bess} BESS je dosaženo vlastní spotřeby {formatDecimal(results.finalSelfConsumptionRatio, 1)}%.
                                To představuje zvýšení o {formatDecimal(results.finalSelfConsumptionRatio - baseEnergy.selfConsumptionRatio, 1)} procentních bodů oproti výchozímu stavu.
                            </p>
                            <p className="mt-2">
                                <strong>Celková roční spotřeba areálu:</strong> {formatNumber(baseEnergy.totalConsumption)} kWh
                            </p>
                            <p>
                                <strong>Pokrytí spotřeby po optimalizaci:</strong> {formatDecimal((results.finalSelfConsumption / baseEnergy.totalConsumption) * 100, 1)}%
                                ({formatDecimal((baseEnergy.selfConsumption / baseEnergy.totalConsumption) * 100, 1)}% původně)
                            </p>
                            <p className="mt-2 text-center font-medium">
                                {!isFinite(results.paybackYears) 
                                    ? "Investice nemá ekonomickou návratnost při současném nastavení." 
                                    : results.paybackYears <= 5
                                        ? "Výborná ekonomická návratnost investice."
                                        : results.paybackYears <= 8
                                            ? "Dobrá návratnost investice."
                                            : results.paybackYears <= 12
                                                ? "Přijatelná návratnost investice."
                                                : "Dlouhá doba návratnosti investice."}
                            </p>
                        </div>
                    </div>
                    </div>
                    <ComparisonTable base={baseEnergy} optimized={results} formatNumber={formatNumber} formatDecimal={formatDecimal} />
                </>
                )}

                {activeTab === 'energy' && (
                <>
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Energetická bilance</h2>
                        <div className="h-60">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={optimizedMixData}
                                        cx="50%"
                                        cy="50%"
                                        labelLine={false}
                                        outerRadius={80}
                                        dataKey="value"
                                    >
                                        {optimizedMixData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={entry.color} />
                                        ))}
                                    </Pie>
                                    <Legend />
                                    <Tooltip formatter={value => formatNumber(value) + " kWh"} />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                        <div className="mt-3 grid grid-cols-2 gap-2">
                            <div className="bg-blue-50 p-2 rounded">
                                <p className="text-sm font-semibold">Původní vlastní spotřeba</p>
                                <p>{formatDecimal(baseEnergy.selfConsumptionRatio, 1)}%</p>
                            </div>
                            <div className="bg-green-50 p-2 rounded">
                                <p className="text-sm font-semibold">Nová vlastní spotřeba</p>
                                <p>{formatDecimal(results.finalSelfConsumptionRatio, 1)}%</p>
                            </div>
                        </div>
                        <div className="mt-2 p-2 rounded bg-gray-50">
                            <p className="text-xs text-gray-600">Alokace energie z BESS: {bessAllocationForMiners}% pro minery, {100-bessAllocationForMiners}% pro jiné využití</p>
                            <p className="text-xs text-gray-600">Využití přetoků: {exportEnergyForBess}% pro BESS, {100-exportEnergyForBess}% přímo pro minery</p>
                            <p className="text-xs text-gray-600">Predikce BTC: {btcGrowthMultiplier}% výchozí hodnoty</p>
                        </div>
                    </div>
                </>
                )}

                {activeTab === 'economics' && (
                <>
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Ekonomická analýza</h2>
                        <div className="grid grid-cols-2 gap-3 mb-3">
                            <div className="bg-red-50 p-2 rounded">
                                <p className="text-sm font-semibold">Celková investice</p>
                                <p className="text-xl font-bold">{formatNumber(results.totalInvestment)} Kč</p>
                            </div>
                            <div className="bg-green-50 p-2 rounded">
                                <p className="text-sm font-semibold">Roční výnos</p>
                                <p className="text-xl font-bold">{formatNumber(results.totalRevenue)} Kč</p>
                            </div>
                        </div>
                        <div className="bg-yellow-50 p-3 rounded mb-3">
                            <p className="text-sm font-semibold">Návratnost investice</p>
                            <p className="text-xl font-bold">{!isFinite(results.paybackYears) ? "N/A" : formatDecimal(results.paybackYears, 1) + " let"}</p>
                        </div>
                        <div className="text-sm">
                            <p><strong>Příjem z těžby:</strong> {formatNumber(results.miningRevenue)} Kč/rok</p>
                            <p><strong>Úspora z BESS:</strong> {formatNumber(results.energySavings)} Kč/rok</p>
                            <p><strong>Prodej přetoků:</strong> {formatNumber(results.exportRevenue)} Kč/rok</p>
                        </div>
                        {/* PieChart pod ekonomikou */}
                        <div className="mt-6 h-52">
                            <ResponsiveContainer width="100%" height="100%">
                                <PieChart>
                                    <Pie
                                        data={economicsPieData}
                                        dataKey="value"
                                        nameKey="name"
                                        cx="50%"
                                        cy="50%"
                                        outerRadius={70}
                                        label
                                    >
                                        {economicsPieData.map((entry, idx) => (
                                            <Cell key={`cell-economics-${idx}`} fill={entry.color} />
                                        ))}
                                    </Pie>
                                    <Tooltip formatter={value => formatNumber(value) + " Kč"} />
                                    <Legend />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </>
                )}

                {activeTab === 'charts' && (
                <>
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Měsíční vlastní spotřeba</h2>
                        <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart
                                    data={monthlyData}
                                    margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                                >
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="name" />
                                    <YAxis domain={[75, 100]} />
                                    <Tooltip />
                                    <Legend />
                                    <Line type="monotone" dataKey="original" name="Původní" stroke="#8884d8" />
                                    <Line type="monotone" dataKey="optimized" name="Optimalizovaná" stroke="#82ca9d" />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    {/* Nový graf návratnosti investice v čase */}
                    <div className="bg-white p-4 rounded shadow mb-6">
                        <h2 className="text-lg font-semibold mb-3">Návratnost investice v čase</h2>
                        <div className="h-72">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={cumulativeRevenues}>
                                    <CartesianGrid strokeDasharray="3 3" />
                                    <XAxis dataKey="year" label={{ value: "Rok", position: "insideBottom", offset: -5 }} />
                                    <YAxis domain={[0, Math.max(results.totalInvestment * 2, results.totalRevenue * 20)]} />
                                    <Tooltip formatter={formatNumber} />
                                    <Legend />
                                    <Line type="monotone" dataKey="cumulative" name="Kumulativní výnosy" stroke="#4CAF50" />
                                    <Line type="monotone" dataKey="investment" name="Celková investice" stroke="#F59E42" strokeDasharray="5 5" />
                                </LineChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                </>
                )}
            </div>
        );
    };

    // Vykreslení aplikace
    const rootElement = document.getElementById('root');
    ReactDOM.render(
        <FVEOptimalizace />,
        rootElement
    );
    </script>

    <!-- Babel pro JSX transformaci -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.2/babel.min.js"></script>
</body>
</html>
  
